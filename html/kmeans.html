<!doctype html>
<html>
   
  <head>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="rangeslider.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.js"></script>
    <script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.js"></script>
    <link rel="stylesheet" href="victoria.css">
    <link rel="stylesheet" href="rangeslider.css">
    <script type="text/javascript">
      var ros;

      function DumpObjectIndented(obj, indent)
      {
        var result = "";
        if (indent == null) indent = "";

        for (var property in obj)
        {
          var value = obj[property];
          if (typeof value == 'string')
            value = "'" + value + "'";
          else if (typeof value == 'object')
          {
            if (value instanceof Array)
            {
              // Just let JS convert the Array to a string!
              value = "[ " + value + " ]";
            }
            else
            {
              // Recursive dump
              // (replace "  " by "\t" or something else if you prefer)
              var od = DumpObjectIndented(value, indent + "  ");
              // If you like { on the same line as the key
              //value = "{\n" + od + "\n" + indent + "}";
              // If you prefer { and } to be aligned
              value = "\n" + indent + "{\n" + od + "\n" + indent + "}";
            }
          }
          result += indent + "'" + property + "' : " + value + ",\n";
        }
        return result.replace(/,\n$/, "");
      }

      function showHideHistogram(checkBoxElement) {
        var histChartId = checkBoxElement.attributes['hist'].value;
        //console.log("checked, id: " + checkBoxElement.id + ', hist id: ' + histChartId);
        var histogramChart = document.getElementById(histChartId);
        //console.log('histogramChart: ' + histogramChart);
        if (checkBoxElement.checked) histogramChart.style.display = 'block';
        else histogramChart.style.display = 'none';
      }

      function getPlotDivName(cluster) {
        return 'cl' + cluster + 'hist';
      }

      function createCheckboxText(cluster) {
        var checkBoxId = 'cb' + getPlotDivName(cluster);
        return '<input type="checkbox" hist="' +
                getPlotDivName(cluster) + '" id="' + checkBoxId + '"  onchange="showHideHistogram(this)"/>';
      }

      var CHART_HEIGHT = 80;
      var feedbackChannel0 = [];
      var feedbackChannel1 = [];
      var feedbackChannel2 = [];
      var clusterColors = [];

      function computeKmeansTableRows() {
        var feedbackRows = '<tr><th>M</th><th style="white-space:nowrap">Statistics <span style="white-space:nowrap" id="status"></span> <span style="white-space:nowrap" id="hoverColor">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></th></tr>';
        for (cluster = 0; cluster < feedbackChannel0.length; cluster++) {
          var fb0 = feedbackChannel0[cluster];
          var fb1 = feedbackChannel1[cluster];
          var fb2 = feedbackChannel2[cluster];
          var cellText = 
            '<b style="color: rgb(31, 119, 180)">hue:</b> [' + fb0.min + '..' + fb0.max + '] ' +
            ', <b style="color: rgb(255, 127, 14)">saturation:</b> [' + fb1.min + '..' + fb1.max + '] ' +
            ', <b style="color: rgb(44, 168, 44)">value:</b> [' + fb2.min + '..' + fb2.max + '] ' +
            ', <b>points: </b>' + fb0.selected_point_count;
          feedbackRows += '<tr class="histogram_data_row"><td bgcolor="#' + clusterColors[cluster].toString(16) + '">X</td>' +
                              '<td class="histogram_data_cell">' + 
                                  cluster + 
                                  ' ' + 
                                  createCheckboxText(cluster) +
                                  ' ' + 
                                  cellText + 
                               '</td>' +
                          '</tr>' +
                          '<tr class="histogram_data_row"><td></td><td><div id="' + getPlotDivName(cluster) + '" style="height: ' + CHART_HEIGHT + '; display: none"></td></tr>';
        }

        return feedbackRows;
      }

      function computeHistogramPlot() {
         for (cluster = 0; cluster < feedbackChannel0.length; cluster++) {
            var fb0 = feedbackChannel0[cluster];
            var fb1 = feedbackChannel1[cluster];
            var fb2 = feedbackChannel2[cluster];
            var hueY = [];
            var satY = [];
            var valY = [];
            var fb0Max = 0;
            var fb1Max = 0;
            var fb2Max = 0;

            for (i = 0; i < fb0.histogram.length; i++) {
              hueY[i] = fb0.histogram[i];
              satY[i] = fb1.histogram[i];
              valY[i] = fb2.histogram[i];
              if (fb0.histogram[i] > fb0Max) fb0Max = fb0.histogram[i];
              if (fb1.histogram[i] > fb1Max) fb1Max = fb1.histogram[i];
              if (fb2.histogram[i] > fb2Max) fb2Max = fb2.histogram[i];
            }

            var huePlot = {
              dx: 1,
              line: { color: 'rgb(31, 119, 180)' },
              name: 'hue',
              type: 'scatter',
              y: hueY,
            };

            var satPlot = {
              dx: 1,
              line: { color: 'rgb(255, 127, 14)' },
              name: 'sat',
              type: 'scatter',
              y: satY,
            };

            var valPlot = {
              dx: 1,
              line: { color: 'rgb(44, 168, 44)' },
              name: 'val',
              type: 'scatter',
              y: valY,
            };

            var layout = {
              autosize: false,
              height: 160,
              margin: {
                b: 30,
                l: 40,
                //pad: 4,
                r: 10,
                t: 0
              },
              shapes: [
                {
                  type: 'line', 
                  x0: fb0.min, y0: 0, x1: fb0.min, y1: fb0Max, 
                  line: {color: 'rgb(31, 119, 180)', dash: 'dashdot'}

                },
                {
                  type: 'line', 
                  x0: fb0.max, y0: 0, x1: fb0.max, y1: fb0Max, 
                  line: {color: 'rgb(31, 119, 180)', dash: 'dashdot'}

                },
                {
                  type: 'line', 
                  x0: fb1.min, y0: 0, x1: fb1.min, y1: fb1Max, 
                  line: {color: 'rgb(255, 127, 14)', dash: 'dashdot'}

                },
                {
                  type: 'line', 
                  x0: fb1.max, y0: 0, x1: fb1.max, y1: fb1Max, 
                  line: {color: 'rgb(255, 127, 14)', dash: 'dashdot'}

                },
                {
                  type: 'line', 
                  x0: fb2.min, y0: 0, x1: fb2.min, y1: fb2Max, 
                  line: {color: 'rgb(44, 168, 44)', dash: 'dashdot'}

                },
                {
                  type: 'line', 
                  x0: fb2.max, y0: 0, x1: fb2.max, y1: fb2Max, 
                  line: {color: 'rgb(44, 168, 44)', dash: 'dashdot'}

                }
              ],
              width: 600,
              xaxis: {
                dtick: 10
              },
              yaxis: {
                title: 'Pixels'
              }
            };

            Plotly.newPlot(getPlotDivName(cluster), [huePlot, satPlot, valPlot], layout);
          }
      }

      var alow_hue_;
      var ahigh_hue_;
      var alow_saturation_;
      var ahigh_saturation_;
      var alow_value_;
      var ahigh_value_;
      var blow_hue_;
      var bhigh_hue_;
      var blow_saturation_;
      var bhigh_saturation_;
      var blow_value_;
      var bhigh_value_;
      
      var canvas;
      var img;
      var statusDiv;

      var cone_detector_input_element_names = [
        "alow_hue_", "ahigh_hue_",
        "alow_saturation_", "ahigh_saturation_",
        "alow_value_", "ahigh_value_",
        "blow_hue_", "bhigh_hue_",
        "blow_saturation_", "bhigh_saturation_",
        "blow_value_", "bhigh_value_"
      ];

      function getConeDetectorParams() {
        alow_hue_ = new ROSLIB.Param({ ros : ros, name : '/cone_detector/alow_hue_' });
        ahigh_hue_ = new ROSLIB.Param({ ros : ros, name : '/cone_detector/ahigh_hue_' });
        alow_saturation_ = new ROSLIB.Param({ ros : ros, name : '/cone_detector/alow_saturation_' });
        ahigh_saturation_ = new ROSLIB.Param({ ros : ros, name : '/cone_detector/ahigh_saturation_' });
        alow_value_ = new ROSLIB.Param({ ros : ros, name : '/cone_detector/alow_value_' });
        ahigh_value_ = new ROSLIB.Param({ ros : ros, name : '/cone_detector/ahigh_value_' });

        alow_hue_.get(function(value) { $("#alow_hue_").val(value).change();});
        ahigh_hue_.get(function(value) { $("#ahigh_hue_").val(value).change();});
        alow_saturation_.get(function(value) { $("#alow_saturation_").val(value).change();});
        ahigh_saturation_.get(function(value) { $("#ahigh_saturation_").val(value).change();});
        alow_value_.get(function(value) { $("#alow_value_").val(value).change();});
        ahigh_value_.get(function(value) { $("#ahigh_value_").val(value).change();});

        blow_hue_ = new ROSLIB.Param({ ros : ros, name : '/cone_detector/blow_hue_' });
        bhigh_hue_ = new ROSLIB.Param({ ros : ros, name : '/cone_detector/bhigh_hue_' });
        blow_saturation_ = new ROSLIB.Param({ ros : ros, name : '/cone_detector/blow_saturation_' });
        bhigh_saturation_ = new ROSLIB.Param({ ros : ros, name : '/cone_detector/bhigh_saturation_' });
        blow_value_ = new ROSLIB.Param({ ros : ros, name : '/cone_detector/blow_value_' });
        bhigh_value_ = new ROSLIB.Param({ ros : ros, name : '/cone_detector/bhigh_value_' });

        blow_hue_.get(function(value) { $("#blow_hue_").val(value).change();});
        bhigh_hue_.get(function(value) { $("#bhigh_hue_").val(value).change();});
        blow_saturation_.get(function(value) { $("#blow_saturation_").val(value).change();});
        bhigh_saturation_.get(function(value) { $("#bhigh_saturation_").val(value).change();});
        blow_value_.get(function(value) { $("#blow_value_").val(value).change();});
        bhigh_value_.get(function(value) { $("#bhigh_value_").val(value).change();});
      }

      function setDynamicParam() {
        var int_vals = [];
        cone_detector_input_element_names.forEach(function(elem) {
          if ($('#' + elem).val() == "") return;
          int_vals.push({name: elem, value: parseInt($('#' + elem).val())});
        });
        var dynamicService = new ROSLIB.Service({
          ros: ros,
          name: '/cone_detector/set_parameters',
          service_type: 'dynamic_reconfigure/ReconfigureRequest'
        });
 
        var request = new ROSLIB.ServiceRequest({
          config: {
              ints: int_vals
          }
        });

        dynamicService.callService(request, function(result) {
          //console.log('Result for service call');
        });
     }

      function main() {
        ros = new ROSLIB.Ros({
          url : 'ws:/xmyx.com:9090'
        });
        document.getElementById('busyDiv').style.display = 'block';
        document.getElementById('errorDiv').style.display = 'none';
        document.getElementById('nonErrorDiv').style.display = 'none';

        getConeDetectorParams();

        var kmeansActionClient = new ROSLIB.ActionClient({
          ros : ros,
          serverName : '/compute_kmeans',
          actionName : 'victoria_perception/KmeansAction'
        });

        var goal = new ROSLIB.Goal({
          actionClient : kmeansActionClient,
          goalMessage : {
            image_topic_name : '/usb_cam/image_raw',
            number_clusters : 16,
            resize_width : 320
          }
        });

        feedbackChannel0 = [];
        feedbackChannel1 = [];
        feedbackChannel2 = [];
        clusterColors = [];

        goal.on('feedback', function(feedback) {
          //console.log('Feedback: ' + feedback.step);
          var fb = JSON.parse(feedback.step);
          if (fb.channel == 0) {
            feedbackChannel0[fb.cluster] = fb;
         } else if (fb.channel == 1) {
            feedbackChannel1[fb.cluster] = fb;
          } else if (fb.channel == 2) {
            feedbackChannel2[fb.cluster] = fb;
          }
        });

        goal.on('result', function(result) {
          document.getElementById('busyDiv').style.display = 'none';
          document.getElementById('errorDiv').style.display = 'none';
          document.getElementById('nonErrorDiv').style.display = 'block';
  //console.log('Final result_msg: ' + result.result_msg);
  //console.log('Final kmeans_result: ' + result.kmeans_result);
         var resultAsArray = JSON.parse(result.kmeans_result);
  //console.log('resultAsArray: ' + DumpObjectIndented(resultAsArray));
          for (i = 0; i < feedbackChannel0.length; i++) {
            clusterColors[i] = (resultAsArray[i].color_rgb[0] * 256 * 256) + (resultAsArray[i].color_rgb[1] * 256) + resultAsArray[i].color_rgb[2];
  //console.log('clusterColors[' + i + ']: ' + clusterColors[i] + ' =0x' + clusterColors[i].toString(16));
          }

          var feedbackTable = document.getElementById("KmeansTable");
          feedbackTable.innerHTML = computeKmeansTableRows();
          computeHistogramPlot();
          document.getElementById('KmeansAnnotatedImage').style.display = 'block';
          document.getElementById('KmeansAnnotatedImage').src="http://xmyx.com:8080/snapshot?topic=/kmeans/annotated_image&width=640&height=480&quality=100" + '&' + new Date().getTime();
          document.getElementById('KmeansAnnotatedImage').setAttribute('crossOrigin', '');
          
          statusDiv = document.getElementById('status');
          img = document.getElementById('KmeansAnnotatedImage');
          img.crossOrigin = "Anonymous";
          function loaded() {
            canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            canvas.getContext('2d').drawImage(img, 0, 0, img.width, img.height);
          }

          if (img.complete) {
            loaded()
          } else {
            img.addEventListener('load', loaded)
            img.addEventListener('error', function() {
                alert('error')
            });
          } 
        });

        ros.on('connection', function() {
          console.log('Connected to websocket server.');
        });

        ros.on('error', function(error) {
          console.log('Error connecting to websocket server: ', error);
          document.getElementById('busyDiv').style.display = 'none';
          document.getElementById('errorDiv').style.display = 'block';
          document.getElementById('nonErrorDiv').style.display = 'none';
        });

        ros.on('close', function() {
          console.log('Connection to websocket server closed.');
        });

        goal.send();      
      }

function findPos(obj) {
    var curleft = 0, curtop = 0;
    if (obj.offsetParent) {
        do {
            curleft += obj.offsetLeft;
            curtop += obj.offsetTop;
        } while (obj = obj.offsetParent);
        return { x: curleft, y: curtop };
    }
    return undefined;
}

function rgbToHex(r, g, b) {
    if (r > 255 || g > 255 || b > 255)
        throw "Invalid color component";
    return ((r << 16) | (g << 8) | b).toString(16);
}

    </script>
  </head>   
  <body onload="main()">
    <div class="errorDiv" id="errorDiv" style="display:none"/>Unable to connect to ROS and servers</div>
    <div class="busyDiv" id="busyDiv" style="display:none"/>Busy talking to the k-means service</div>
    <div id="nonErrorDiv" style="display:none">
      <table>
        <tr>
          <td><img id="KmeansAnnotatedImage" style="display:none"/></td>
          <td><img id="ConeDetectorAnnotatedImage" src="http://xmyx.com:8080/stream?topic=/cone_detector/annotated_image&width=640&height=480" /></td>
        </tr>
        <tr>
          <td style="vertical-align: top"><table id="KmeansTable"></table></td>
          <td style="vertical-align: top">
            <table class="cone_detector_table">
              <tr class="cone_detector_table_row">
                <td>
                  <table>
                    <tr>
                      <th>Param</th>
                      <th>Value</th>
                      <th>Param</th>
                      <th>Value</th>
                    </tr>
                    <tr>
                      <td class="bold_cell">alow_hue</td>
                      <td class="data_cell">
                        <input type="number" id="alow_hue_" class="cone_detector_input" max="179">
                      </td>
                      <td class="bold_cell">ahigh_hue</td>
                      <td class="data_cell">
                        <input type="number" id="ahigh_hue_" class="cone_detector_input" max="179">
                      </td>
                    </tr>
                    <tr>
                      <td class="bold_cell">alow_saturation</td>
                      <td class="data_cell">
                        <input type="number" id="alow_saturation_" class="cone_detector_input" max="255">
                      </td>
                      <td class="bold_cell">ahigh_saturation</td>
                      <td class="data_cell">
                        <input type="number" id="ahigh_saturation_" class="cone_detector_input" max="255">
                      </td>
                    </tr>
                    <tr>
                      <td class="bold_cell">alow_value</td>
                      <td class="data_cell">
                        <input type="number" id="alow_value_" class="cone_detector_input" max="255">
                      </td>
                      <td class="bold_cell">ahigh_value</td>
                      <td class="data_cell">
                        <input type="number" id="ahigh_value_" class="cone_detector_input" max="255">
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
              <tr class="cone_detector_table_row">
                <td style="vertical-align: top">
                  <table>
                  <tr>
                    <th>Param</th>
                    <th>Value</th>
                    <th>Param</th>
                    <th>Value</th>
                  </tr>
                    <tr>
                      <td class="bold_cell">blow_hue</td>
                      <td class="data_cell">
                        <input type="number" id="blow_hue_" class="cone_detector_input" max="179">
                      </td>
                      <td class="bold_cell">bhigh_hue</td>
                      <td class="data_cell">
                        <input type="number" id="bhigh_hue_" class="cone_detector_input" max="179">
                      </td>
                    </tr>
                    <tr>
                      <td class="bold_cell">blow_saturation</td>
                      <td class="data_cell">
                        <input type="number" id="blow_saturation_" class="cone_detector_input" max="255">
                      </td>
                      <td class="bold_cell">bhigh_saturation</td>
                      <td class="data_cell">
                        <input type="number" id="bhigh_saturation_" class="cone_detector_input" max="255">
                      </td>
                    </tr>
                    <tr>
                      <td class="bold_cell">blow_value</td>
                      <td class="data_cell">
                        <input type="number" id="blow_value_" class="cone_detector_input" max="255">
                      </td>
                      <td class="bold_cell">bhigh_value</td>
                      <td class="data_cell">
                        <input type="number" id="bhigh_value_" class="cone_detector_input" max="255">
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </td>
        </tr>
      </table>
    </div>
    <script>
      var $document = $(document);
      $("#KmeansAnnotatedImage").mousemove(function(e) {
        var pos = findPos(this);
        var x = e.pageX - pos.x;
        var y = e.pageY - pos.y;
        var coord = "x:" + x + ", y:" + y;
        var c = canvas.getContext('2d');
        var p = c.getImageData(x, y, 1, 1).data;
        var hex = "#" + ("000000" + rgbToHex(p[0], p[1], p[2])).slice(-6);
        statusDiv.innerHTML = 'x:' + x + ', y:' + y + ' RGB color: ' + hex;
        document.getElementById('hoverColor').style.backgroundColor = 'rgb(' + p[0] + ',' + p[1] + ', ' + p[2] + ')';
      });

      $document.on('change', '.cone_detector_input', function(e) {
        var input_element = e.target;
        //console.log('change: ' + input_element.id + ', value: ' + input_element.value + '. max: ' + input_element.max);
        if (parseInt(input_element.value) > parseInt(input_element.max)) {
          input_element.value = input_element.max;
        }
        if (parseInt(input_element.value) < 0) {
          input_element.value = 0;
        }
        eval(input_element.id).set(parseInt(input_element.value));
        setDynamicParam();
      });
      //$(".cone_detector_input").on('change') {}
    </script>   
  </body>
</html>
